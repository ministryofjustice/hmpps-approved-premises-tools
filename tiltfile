docker_compose("./docker-compose.yml")

config.define_bool("local-api")
config.define_bool("local-ui")
config.define_bool("second-local-ui")

cfg = config.parse()

local_api = cfg.get("local-api", False)
local_ui = cfg.get("local-ui", False)
second_local_ui = cfg.get("second-local-ui", False)

resources = [
    "api",
    "frontend",
    "wiremock",
    "database",
    "redis",
    "localstack",
]

if local_api:
    resources.remove("api")
    local_resource(
        "local_api",
        serve_cmd="./gradlew bootRunDebug",
        # Note! These checks only wait for containers to start, ideally we'd wait for them to be ready
        # see https://docs.tilt.dev/resource_dependencies.html
        # "For dc_resource: the container is started (NB: Tilt doesnâ€™t currently observe docker-compose health checks)"
        resource_deps=["database", "redis"],
        serve_dir=os.getenv("LOCAL_CAS_API_PATH"),
        readiness_probe=probe(
            period_secs=15, http_get=http_get_action(port=8080, path="/health")
        ),
        serve_env={
            "BOOT_RUN_ENV_FILE": os.getcwd() + '/.env.api.dev-upstream-gradle'
        }
    )
    resources.append("local_api")
else:
    dc_resource(
        "api",
        resource_deps=[]
    )

if local_ui:
    resources.remove("frontend")
    local_resource(
        "local_ui",
        cmd="npm install",
        serve_cmd="npm run start:dev",
        serve_dir=os.getenv("LOCAL_CAS_UI_PATH"),
        dir=os.getenv("LOCAL_CAS_UI_PATH"),
        resource_deps=[],
        readiness_probe=probe(
            period_secs=15, http_get=http_get_action(port=3000, path="/health")
        ),
        serve_env={
            "PROVIDE_PERFORMANCE_HUB_REPORTS": "true",
        }
    )
    resources.append("local_ui")

if second_local_ui:
    local_resource(
        "second_local_ui",
        cmd="npm install",
        serve_cmd="PORT=3002 npm run start:dev",
        serve_dir=os.getenv("SECOND_LOCAL_CAS_UI_PATH"),
        dir=os.getenv("SECOND_LOCAL_CAS_UI_PATH"),
        resource_deps=[],
        readiness_probe=probe(
            period_secs=15, http_get=http_get_action(port=3002, path="/health")
        ),
        serve_env={
            "PROVIDE_PERFORMANCE_HUB_REPORTS": "true",
        }
    )
    resources.append("second_local_ui")

config.clear_enabled_resources()
config.set_enabled_resources(resources)
