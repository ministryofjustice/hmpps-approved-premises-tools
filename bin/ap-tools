#!/usr/bin/env bash

command=$1 ; shift


pull_changes_from_main() {

# check if AP_TOOLS_DIR is set, pull changes if checked out branch is 'main'
# Ensure required environment variable is set
if [ -z "$AP_TOOLS_DIR" ]; then
  echo "AP_TOOLS_DIR environment variable is not set, you will need to manually pull changes from the ap-tools repo."
else
  # Pull changes if current branch is main, and there's no local changes.

  # Get the current branch
  CURRENT_BRANCH=$(git -C "$AP_TOOLS_DIR" rev-parse --abbrev-ref HEAD)

  echo $CURRENT_BRANCH

  if [ "$CURRENT_BRANCH" = "main" ]; then
    echo "AP-tools branch is 'main'. Attempting to pull latest changes..."

    # Fetch updates from remote
    if ! git -C "$AP_TOOLS_DIR" fetch; then
      echo "Error: Failed to fetch from remote."
      exit 1
    fi

    # Try a fast-forward merge only (will fail if conflicts exist)
    if ! git -C "$AP_TOOLS_DIR" merge --ff-only origin/main; then
      echo "Error: Pull failed. Local changes would conflict with remote. Aborting."
      exit 1
    fi

    echo "Pull complete. 'main' is up to date."
  else
    echo "Current branch is '$CURRENT_BRANCH'. Skipping pull."
  fi
fi
}

if [ "$command" = "server" ]; then
  "$(dirname "$0")/server" "$@"
elif [ "$command" = "--help" ]; then
  echo "Usage: ap-tools <command>"
  echo "Commands:"
  echo "  start"
  echo "  stop"
  echo "  server start"
  echo "  server stop"
  echo "Options:"
  echo "  --local-ui"
  echo "  --local-api"
elif [ "$command" = "start" ]; then

  pull_changes_from_main

  while true; do
    echo "Choose the service to start."
    echo "1) cas1"
    echo "2) cas2"
    echo "3) cas3"
    echo "b) cas2v2 (bail)"
    read -p "Start which CAS? (1/2/3/b): " casx
    case $casx in
      [1]* ) command="$command --cas1"; break;;
      [2]* ) command="$command --cas2"; break;;
      [b]* ) command="$command --cas2v2"; break;;
      [3]* ) command="$command --cas3"; break;;
      * ) echo "Please answer 1, 2, 3, or b.";;
    esac
  done
  while true; do
    read -p "Start local UI? (y/n): " ui
    case $ui in
        [Yy]) command="$command --local-ui"; break;;
        [Nn]) break;;
        * ) echo "Please answer (y/n).";;
    esac
  done

  while true; do
    read -p "Start local API? (y/n): " api
    case $api in
        [Yy] ) command="$command --local-api"; break;;
        [Nn] ) break;;
        * ) echo "Please answer yes or no (y/n).";;
    esac
  done

  echo "starting ap-tools with: $command"
   "$(dirname "$0")/server" $command

elif [ "$command" = "stop" ]; then
  while true; do
    read -p "Clear databases? (y/n): " db
    case $db in
        [Yy] ) command="$command --clear-databases"; break;;
        [Nn] ) break;;
        * ) echo "Please answer yes or no (y/n).";;
    esac
  done
  echo "stopping ap-tools with: $command"
  "$(dirname "$0")/server" $command

else
  echo "Unknown command $1"
  exit 1
fi
